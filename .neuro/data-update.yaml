kind: batch
title: demo-oss-dogs-batch
id: mlops_demo_oss_dogs

defaults:
  cache:
    strategy: none
volumes:
  data:
    remote: storage:$[[ flow.flow_id ]]/data
    mount: /data
  remote_dataset:
    remote: storage:$[[ flow.flow_id ]]/dataset
    mount: /dataset
  project:
    remote: storage:$[[ flow.flow_id ]]
    mount: /project
  mlflow_artifacts:
    remote: storage:$[[ flow.flow_id ]]/mlruns
    mount: /usr/local/share/mlruns
  label_studio:
    remote: storage:$[[ flow.flow_id ]]/label-studio
    mount: /storage-label-studio-project
  src:
    remote: storage:$[[ flow.flow_id ]]/src
    mount: /project/src
  config:
    remote: storage:$[[ flow.flow_id ]]/config
    mount: /project/config
params:
  mlflow_server_uri: ~

images:
  train:
    ref: image:$[[ flow.flow_id ]]:21.1.13-pachyderm
  seldon:
    ref: image:$[[ flow.flow_id ]]/seldon:20.12.16

tasks:
  - id: train
    image: $[[ images.train.ref ]]
    preset: cpu-small
    life_span: 10d
    volumes:
      - $[[ volumes.mlflow_artifacts.ref_rw ]]
      - secret:gh-rsa:/root/.ssh/id-rsa
    env:
      EXPOSE_SSH: "yes"
      MLFLOW_TRACKING_URI: ${{ params.mlflow_server_uri }}
      PYTHONPATH: /usr/project
      PROJECT: /usr/project
      PACHY_URI: api.pachyderm.mlops.neu.ro:650
      PACHY_REPO: dogs-demo
    bash: |
        echo "IdentityFile ~/.ssh/id-rsa" > ~/.ssh/config
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        git clone -b master git@github.com:neuro-inc/mlops-demo-oss-dogs.git ${PROJECT}
        
        # Init pachctl
        pachctl config update context default --pachd-address ${PACHY_URI}
        pachctl config set active-context default
        pachctl inspect repo ${PACHY_REPO} || pachctl create repo ${PACHY_REPO}
        
        # Pull dataset: 
        pachctl get file ${PACHY_REPO}@master:/data/ -r -o ${PROJECT}/data/ | tee
        ls -R ${PROJECT}/data

        python -u ${PROJECT}/src/train.py \
          --data_dir ${PROJECT}/data/Images \
          --data_description ${PROJECT}/data/result.json